<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مدير كروت الواي فاي</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
body { font-family: 'Tajawal', Arial, sans-serif; margin: 0; background: linear-gradient(to bottom, #e0f7fa, #0288d1); color: #222;}
header { background-color: #0288d1; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2);}
.header-info { font-size: 14px; display: flex; flex-direction: column; align-items: flex-end; gap: 3px;}
#logout-btn, #add-cards-icon, #admin-btn { background: none; border: none; color: white; font-weight: bold; cursor: pointer; margin-right: 8px; font-size: 16px; transition: 0.2s;}
#logout-btn:hover, #add-cards-icon:hover, #admin-btn:hover { color: #ffd600; }
#main-section { min-height: 100vh; }
.container { padding: 1rem; max-width: 950px; margin: auto; }
.card { background: white; border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);}
.center { max-width: 400px; margin: 40px auto 0; }
input, select, textarea, button { font-family: inherit; margin-top: 7px; padding: 10px; border-radius: 6px; border: 1px solid #b5e0f7; width: 100%; box-sizing: border-box;}
input[type="password"], input[type="email"], input[type="tel"] { margin-bottom: 10px; }
button { background: #0288d1; color: #fff; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background 0.2s;}
button.danger { background: #e53935; }
button:disabled { background: #bbb; cursor: not-allowed; }
.scroll-stats { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px;}
.stat-circle { min-width: 80px; height: 80px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.13); flex-shrink: 0;}
.f100 { background: #26c6da; }.f200 { background: #42a5f5; }.f250 { background: #ab47bc; }.f500 { background: #ff7043; }
.f1000 { background: #ef5350; }.f1500 { background: #7b1fa2; }.f2000 { background: #388e3c; }.f3000 { background: #ffa000; }.f4000 { background: #c62828; }
.counter { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 15px 0 0 0;}
.counter button { width: 32px; height: 32px; font-size: 20px; border-radius: 7px; border: none; background: linear-gradient(to bottom, #b3e5fc, #0288d1); color: white; cursor: pointer;}
.counter span { font-size: 1.3rem; min-width: 32px; text-align: center; display: inline-block;}
.sales-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;}
.sales-card { background: linear-gradient(to bottom, #ffffff, #f1f8ff); border: 2px solid #81d4fa; border-radius: 10px; padding: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.07); text-align: center; transition: 0.3s;}
.sales-card:hover { transform: translateY(-5px);}
.sales-card .sell-btn:disabled { background: #bbb; color: #eee;}
table { width: 100%; border-collapse: collapse; text-align: center; margin-top: 10px;}
th, td { padding: 7px 3px; }
th { background: #e1f5fe; }
tr:nth-child(even) { background: #f9f9f9;}
.error { color: #e53935; text-align: center;}
.modal { display:none; position: fixed; top: 0; right: 0; left: 0; bottom: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;}
.modal-content { background: #fff; border-radius: 14px; padding: 25px 20px; max-width: 400px; width: 95%; text-align: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2);}
.modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: center;}
#modal-cards-list { background: #f1f8ff; border: 1px solid #90caf9; padding: 10px; border-radius: 8px; margin-bottom: 12px; white-space: pre-wrap; direction:ltr; text-align:left;}
.toast { visibility: hidden; min-width: 270px; max-width: 90vw; color: #fff; text-align: center; border-radius: 6px; padding: 16px 22px; position: fixed; z-index: 9999; left: 50%; top: 22px; transform: translateX(-50%); font-size: 1rem; font-weight: bold; box-shadow: 0 3px 10px rgba(0,0,0,0.17); opacity: 0; transition: opacity 0.3s, top 0.3s;}
.toast-success { background: #43a047; }
.toast-error { background: #e53935; }
.toast-warning { background: #fbc02d; color: #222; }
.toast.show { visibility: visible; opacity: 1; top: 56px;}
input[type="checkbox"] { width: auto; margin-left: 6px;}
#loader { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.88); z-index:9999; justify-content:center; align-items:center;}
#loader .loader-content { background:#fff; padding:32px 36px 22px 36px; border-radius:15px; box-shadow:0 6px 22px rgba(0,0,0,0.13); display:flex; flex-direction:column; align-items:center;}
.spinner { border: 6px solid #e0f7fa; border-top: 6px solid #0288d1; border-right: 6px solid #fbc02d; border-bottom: 6px solid #ab47bc; border-left: 6px solid #43a047; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; margin: 0 auto;}
@keyframes spin { 100% { transform: rotate(360deg); } }
@media (max-width: 650px) { .container { padding: 0.4rem; } .sales-section { grid-template-columns: 1fr; } .scroll-stats { flex-wrap: wrap; } header { flex-direction: column; gap: 8px;}}
::-webkit-scrollbar { width: 6px; background: #f2f2f2;}
::-webkit-scrollbar-thumb { background: #b3e5fc; border-radius: 5px;}
  </style>
</head>
<body>
  <!-- شاشة الانتظار -->
  <div id="loader">
    <div class="loader-content">
      <div class="spinner"></div>
      <span style="margin-top:18px; font-size:18px; color:#0288d1; font-weight:bold;">الرجاء الانتظار قليلاً...</span>
    </div>
  </div>
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  <!-- ====== Authentication Section ====== -->
  <div id="auth-section" class="card center">
    <h2>تسجيل الدخول</h2>
    <input type="email" id="email" placeholder="البريد الإلكتروني" required autocomplete="username"/>
    <input type="password" id="password" placeholder="كلمة المرور" required autocomplete="current-password"/>
    <button id="login-btn">دخول</button>
    <button id="google-btn" style="background:#388e3c;">دخول بجوجل</button>
    <div style="margin-top:10px; font-size:15px;">
      <span>ليس لديك حساب؟</span>
      <button id="register-btn" style="background:#42a5f5;">إنشاء حساب جديد</button>
    </div>
    <div style="margin-top:8px;">
      <button id="forgot-btn" style="background:#ffd600; color:#333;">نسيت كلمة المرور؟</button>
    </div>
    <p id="auth-error" class="error"></p>
  </div>
  <!-- ====== Register Modal ====== -->
  <div id="register-modal" class="modal">
    <div class="modal-content">
      <h2>إنشاء حساب جديد</h2>
      <input type="text" id="reg-name" placeholder="اسم المستخدم (اختياري)"/>
      <input type="email" id="reg-email" placeholder="البريد الإلكتروني" required/>
      <input type="password" id="reg-password" placeholder="كلمة المرور" required/>
      <input type="tel" id="reg-phone" placeholder="رقم الهاتف (اختياري)"/>
      <button id="create-account-btn">إنشاء الحساب</button>
      <button id="close-reg-modal" style="background:#eee; color:#222;">إلغاء</button>
      <p id="reg-error" class="error"></p>
    </div>
  </div>
  <!-- ====== Forgot Password Modal ====== -->
  <div id="forgot-modal" class="modal">
    <div class="modal-content">
      <h2>استعادة كلمة المرور</h2>
      <input type="email" id="forgot-email" placeholder="البريد الإلكتروني" required/>
      <button id="send-reset-btn">إرسال رابط الاستعادة</button>
      <button id="close-forgot-modal" style="background:#eee; color:#222;">إغلاق</button>
      <p id="forgot-error" class="error"></p>
    </div>
  </div>
  <!-- ====== Main Section ====== -->
  <div id="main-section" style="display:none;">
    <!-- ... بقية واجهة البرنامج (كما في الكود السابق) ... -->
  </div>
  <!-- Firebase SDK -->
  <script type="module">
// ====== شاشة الانتظار ======
function showLoader(msg) {
  document.getElementById("loader").style.display = "flex";
  document.querySelector("#loader span").textContent = msg || "الرجاء الانتظار قليلاً...";
}
function hideLoader() { document.getElementById("loader").style.display = "none"; }

// ===== Toast Notification =====
const successSound = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQgAAACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgI");
const errorSound = new Audio("data:audio/wav;base64,UklGRjQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAAAAgAAAAAAAgAAAAAAAgAAAAAAAgAAAAAAAgAAAAAAAgAAAAAAAgAA");
function showToast(msg, type="success") {
  const toast = document.getElementById("toast");
  toast.className = "toast toast-" + (type === "success" ? "success" : (type === "error" ? "error" : "warning"));
  toast.textContent = msg;
  toast.classList.add("show");
  if (type === "success") successSound.play();
  else if (type === "error") errorSound.play();
  setTimeout(()=>{ toast.classList.remove("show"); }, 2900);
}

// ====== Firebase ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, doc, query, where, orderBy, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwWMM-R4v02BfIcviIPxz5Q9qu-OIQXTQ",
  authDomain: "alsaria-net.firebaseapp.com",
  projectId: "alsaria-net",
  storageBucket: "alsaria-net.appspot.com",
  messagingSenderId: "115940202511",
  appId: "1:115940202511:web:f7a620c222a1204dbcab7a",
  measurementId: "G-NWLYRWSQBH"
};
const OWNER_EMAIL = "alsaria-net";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ====== إعدادات البرنامج ======
const categories = ["100", "200", "250", "500", "1000", "1500", "2000", "3000", "4000"];
const prices = {
  "100": 100, "200": 200, "250": 250, "500": 500, "1000": 1000,
  "1500": 1500, "2000": 2000, "3000": 3000, "4000": 4000
};
const colors = {
  "100": "f100", "200": "f200", "250": "f250", "500": "f500", "1000": "f1000",
  "1500": "f1500", "2000": "f2000", "3000": "f3000", "4000": "f4000"
};
let saleCounters = {};
let cardsData = {};
let currentUser = null;
let userData = null;
let showAllLogs = false;
let usersMap = {};
let soldContent = "";
let soldCategory = "";

// ====== مصادقة ======
window.addEventListener('DOMContentLoaded', () => {
document.getElementById('login-btn').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  document.getElementById("auth-error").textContent = "";
  showLoader("جاري تسجيل الدخول...");
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    showToast("بيانات الدخول غير صحيحة!", "error");
    document.getElementById("auth-error").textContent = "بيانات الدخول غير صحيحة!";
    hideLoader();
  }
};
document.getElementById('google-btn').onclick = async () => {
  const provider = new GoogleAuthProvider();
  showLoader("جاري الدخول عبر جوجل...");
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    showToast("فشل الدخول عبر جوجل!", "error");
    document.getElementById("auth-error").textContent = "فشل الدخول عبر جوجل!";
    hideLoader();
  }
};
document.getElementById('logout-btn').onclick = async () => {
  showLoader("جاري تسجيل الخروج...");
  try {
    await signOut(auth);
    hideLoader();
  } catch {
    hideLoader();
  }
};
});

// ====== إنشاء حساب ======
function generateAccountNumber() {
  return Math.floor(100 + Math.random() * 900);
}
async function uniqueAccountNumber() {
  let accNum, exists;
  do {
    accNum = generateAccountNumber();
    const q = query(collection(db, "users"), where("accountNumber", "==", accNum));
    const snap = await getDocs(q);
    exists = !snap.empty;
  } while (exists);
  return accNum;
}
document.getElementById('register-btn').onclick = () => {
  document.getElementById("register-modal").style.display = "flex";
  document.getElementById('reg-error').textContent = "";
};
document.getElementById("close-reg-modal").onclick = () => {
  document.getElementById("register-modal").style.display = "none";
};
document.getElementById("create-account-btn").onclick = async () => {
  const name = document.getElementById("reg-name").value.trim();
  const email = document.getElementById("reg-email").value.trim();
  const password = document.getElementById("reg-password").value.trim();
  const phone = document.getElementById("reg-phone").value.trim();
  if (!email || !password) {
    document.getElementById("reg-error").textContent = "يرجى تعبئة البريد وكلمة السر";
    return;
  }
  showLoader("جاري إنشاء الحساب...");
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const accNum = await uniqueAccountNumber();
    await addDoc(collection(db, "users"), {
      uid: userCredential.user.uid,
      email,
      name,
      phone,
      balance: 0,
      role: "user",
      permissions: {
        addCards: false,
        sellCards: true,
        seeAllLogs: false,
        transfer: false
      },
      accountNumber: accNum
    });
    document.getElementById("register-modal").style.display = "none";
    showToast("تم إنشاء الحساب بنجاح! يمكنك تسجيل الدخول.", "success");
    hideLoader();
  } catch (e) {
    document.getElementById("reg-error").textContent = "فشل إنشاء الحساب: " + (e.code?.includes("email-already-in-use") ? "البريد مستخدم من قبل" : e.message);
    showToast("فشل إنشاء الحساب!", "error");
    hideLoader();
  }
};

// ====== استعادة كلمة المرور ======
document.getElementById('forgot-btn').onclick = () => {
  document.getElementById("forgot-modal").style.display = "flex";
  document.getElementById("forgot-error").textContent = "";
};
document.getElementById("close-forgot-modal").onclick = () => {
  document.getElementById("forgot-modal").style.display = "none";
};
document.getElementById("send-reset-btn").onclick = async () => {
  const email = document.getElementById("forgot-email").value.trim();
  if (!email) {
    document.getElementById("forgot-error").textContent = "يرجى إدخال البريد الإلكتروني";
    return;
  }
  showLoader("جاري إرسال رابط الاستعادة...");
  try {
    await sendPasswordResetEmail(auth, email);
    document.getElementById("forgot-modal").style.display = "none";
    showToast("تم إرسال رابط استعادة كلمة المرور إلى بريدك.", "success");
    hideLoader();
  } catch (e) {
    document.getElementById("forgot-error").textContent = "تعذر الإرسال: " + e.message;
    showToast("تعذر إرسال رابط الاستعادة!", "error");
    hideLoader();
  }
};

// ====== متابعة حالة تسجيل الدخول ======
onAuthStateChanged(auth, async (user) => {
  if (user) {
    showLoader("جاري تحميل البيانات...");
    try {
      let q = query(collection(db, "users"), where("uid", "==", user.uid));
      let snap = await getDocs(q);
      if (!snap.empty) {
        userData = snap.docs[0].data();
        userData._docid = snap.docs[0].id;
      } else {
        userData = {
          uid: user.uid, email: user.email, role: "owner", balance: 0, accountNumber: 100, name: "مالك الشبكة",
          permissions: { addCards: true, sellCards: true, seeAllLogs: true, transfer: true }
        };
        await addDoc(collection(db, "users"), userData);
      }
      await loadUsers();
      await postLoginUI();
      await initApp();
      hideLoader();
    } catch(e) {
      hideLoader();
      showToast("حدث خطأ في تحميل البيانات", "error");
    }
  } else {
    document.getElementById('main-section').style.display = "none";
    document.getElementById('auth-section').style.display = "";
    hideLoader();
  }
});

async function loadUsers() {
  usersMap = {};
  const snap = await getDocs(collection(db, "users"));
  snap.forEach(docx => {
    const d = docx.data();
    usersMap[d.uid] = d;
    if (d.accountNumber) usersMap[d.accountNumber] = d;
  });
}

async function postLoginUI() {
  document.getElementById('auth-section').style.display = "none";
  document.getElementById('main-section').style.display = "";
  document.getElementById("user-balance").textContent = `رصيدك الحالي: ${userData.balance ?? 0} ريال`;
  document.getElementById("user-account-number").textContent = `رقم حسابك: ${userData.accountNumber ?? "-"}`
  document.getElementById("user-name").textContent = userData.name ? `مرحباً ${userData.name}` : "";
  let isOwner = userData.role === "owner" || (userData.email && userData.email.includes(OWNER_EMAIL));
  document.getElementById('owner-section').style.display = isOwner ? "" : "none";
  document.getElementById("admin-btn").style.display = isOwner ? "inline-block" : "none";
  document.getElementById("add-cards-icon").style.display = (isOwner || userData.permissions?.addCards) ? "inline-block" : "none";
  if (isOwner) await renderUsersTable();
}

async function renderUsersTable() {
  const usersSnap = await getDocs(collection(db, "users"));
  let html = `<table style="font-size:15px;">
    <tr>
      <th>اسم المستخدم</th>
      <th>البريد</th>
      <th>رقم الحساب</th>
      <th>إدخال كروت</th>
      <th>بيع كروت</th>
      <th>سجلات العمليات</th>
      <th>تحويل رصيد</th>
      <th>تحديث</th>
    </tr>`;
  usersSnap.forEach(doc => {
    const u = doc.data();
    if(u.role === "owner") return;
    html += `<tr>
      <td>${u.name || "-"}</td>
      <td>${u.email}</td>
      <td>${u.accountNumber}</td>
      <td><input type="checkbox" ${u.permissions?.addCards ? "checked" : ""} id="addCards-${doc.id}"></td>
      <td><input type="checkbox" ${u.permissions?.sellCards ? "checked" : ""} id="sellCards-${doc.id}"></td>
      <td>
        <select id="seeAllLogs-${doc.id}">
          <option value="own" ${u.permissions?.seeAllLogs ? "" : "selected"}>سجله فقط</option>
          <option value="all" ${u.permissions?.seeAllLogs ? "selected" : ""}>جميع السجلات</option>
        </select>
      </td>
      <td><input type="checkbox" ${u.permissions?.transfer ? "checked" : ""} id="transfer-${doc.id}"></td>
      <td><button onclick="updateUserPermissions('${doc.id}')">تحديث</button></td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("users-table").innerHTML = html;
}
window.updateUserPermissions = async function(docid) {
  showLoader("جاري تحديث الصلاحيات...");
  const addCards = document.getElementById(`addCards-${docid}`).checked;
  const sellCards = document.getElementById(`sellCards-${docid}`).checked;
  const seeAllLogs = document.getElementById(`seeAllLogs-${docid}`).value === "all";
  const transfer = document.getElementById(`transfer-${docid}`).checked;
  await updateDoc(doc(db, "users", docid), {
    permissions: { addCards, sellCards, seeAllLogs, transfer }
  });
  showToast("تم تحديث الصلاحيات", "success");
  await loadUsers();
  await renderUsersTable();
  hideLoader();
};

// ====== وظائف التطبيق ======
async function initApp() {
  renderSalesButtons();
  await updateStats();
  await updateTotal();
  await updateLog();
}

async function updateStats() {
  cardsData = {};
  for (let cat of categories) cardsData[cat] = [];
  const q = query(collection(db, "cards"), where("sold", "==", false));
  const snapshot = await getDocs(q);
  snapshot.forEach(docx => {
    const d = docx.data();
    if (categories.includes(d.category)) cardsData[d.category].push({ id: docx.id, code: d.code });
  });
  const stats = document.getElementById("card-stats");
  stats.innerHTML = "";
  categories.forEach(cat => {
    const count = cardsData[cat].length;
    stats.innerHTML += `<div class="stat-circle ${colors[cat]}">${cat}<br><span>${count}</span></div>`;
  });
}

function renderSalesButtons() {
  const container = document.getElementById("sales-buttons");
  container.innerHTML = "";
  categories.forEach(cat => {
    saleCounters[cat] = 0;
    container.innerHTML += `
      <div class="sales-card">
        <h3>فئة ${cat}</h3>
        <div class="counter">
          <button onclick="window.adjustCount('${cat}', -1)">-</button>
          <span id="count-${cat}">0</span>
          <button onclick="window.adjustCount('${cat}', 1)">+</button>
        </div>
        <button class="sell-btn" id="sell-${cat}" onclick="window.sellCards('${cat}')" disabled>بيع الكروت</button>
      </div>`;
  });
}
window.adjustCount = function(cat, delta) {
  saleCounters[cat] = Math.max(0, saleCounters[cat] + delta);
  document.getElementById(`count-${cat}`).textContent = saleCounters[cat];
  document.getElementById(`sell-${cat}`).disabled = saleCounters[cat] === 0;
};
window.sellCards = async function(cat) {
  if (userData.role !== "owner" && !userData.permissions?.sellCards) {
    showToast("ليست لديك صلاحية بيع الكروت.", "error");
    return;
  }
  const count = saleCounters[cat];
  if (!cardsData[cat] || cardsData[cat].length < count) {
    showToast("عدد الكروت غير كافٍ في هذه الفئة.", "error");
    return;
  }
  let price = prices[cat] * count;
  if (userData.role !== "owner" && (userData.balance ?? 0) < price) {
    showToast("رصيدك غير كافٍ لإتمام هذه العملية.", "error");
    return;
  }
  showLoader("جاري بيع الكروت...");
  try {
    const sold = cardsData[cat].slice(0, count);
    const now = new Date();
    const time = now.toLocaleTimeString();
    const date = now.toLocaleDateString();
    for (let card of sold) {
      await updateDoc(doc(db, "cards", card.id), { sold: true, soldAt: serverTimestamp(), soldTo: userData.uid });
      await addDoc(collection(db, "salesLog"), {
        code: card.code,
        category: cat,
        date, time,
        soldAt: serverTimestamp(),
        user: userData.uid,
        userEmail: userData.email,
        userName: userData.name || ""
      });
    }
    if (userData.role !== "owner") {
      userData.balance = (userData.balance ?? 0) - price;
      await updateDoc(doc(db, "users", userData._docid), { balance: userData.balance });
      document.getElementById("user-balance").textContent = `رصيدك الحالي: ${userData.balance} ريال`;
    }
    await updateStats();
    await updateTotal();
    saleCounters[cat] = 0;
    document.getElementById(`count-${cat}`).textContent = 0;
    document.getElementById(`sell-${cat}`).disabled = true;
    showModal(cat, sold.map(e => e.code));
    showToast("تم بيع الكروت بنجاح!", "success");
    hideLoader();
  } catch (e) {
    hideLoader();
    showToast("حدث خطأ أثناء البيع", "error");
  }
};

document.getElementById("add-cards-icon").onclick = () => {
  document.getElementById("add-cards-modal").style.display = "flex";
};
document.getElementById("close-add-cards").onclick = () => {
  document.getElementById("add-cards-modal").style.display = "none";
};
document.getElementById("add-cards-btn").onclick = async () => {
  if (userData.role !== "owner" && !userData.permissions?.addCards) {
    showToast("ليست لديك صلاحية إدخال الكروت.", "error");
    return;
  }
  const cat = document.getElementById("card-category").value;
  const lines = document.getElementById("cards-input").value.trim().split("\n").filter(Boolean);
  if (!lines.length) return showToast("لم يتم إدخال أي كروت.", "error");
  showLoader("جاري حفظ الكروت...");
  try {
    for (let code of lines) {
      await addDoc(collection(db, "cards"), { code, category: cat, sold: false });
    }
    document.getElementById("cards-input").value = "";
    await updateStats();
    document.getElementById("add-cards-modal").style.display = "none";
    showToast("تم حفظ الكروت بنجاح.", "success");
    hideLoader();
  } catch(e) {
    hideLoader();
    showToast("حدث خطأ أثناء حفظ الكروت", "error");
  }
};

async function updateTotal() {
  const q = query(collection(db, "salesLog"));
  const snapshot = await getDocs(q);
  let total = 0;
  snapshot.forEach(docx => {
    const d = docx.data();
    if (prices[d.category]) total += prices[d.category];
  });
  if (userData.role === "owner" || (userData.email && userData.email.includes(OWNER_EMAIL))) {
    document.getElementById("user-balance").innerHTML += ` | <span style="color:#0288d1;">إجمالي المبيعات: <strong>${total} ريال</strong></span>`;
  }
}

async function updateLog() {
  const table = document.getElementById("sales-log");
  table.innerHTML = "";
  let q;
  if (
    userData.role === "owner" ||
    userData.permissions?.seeAllLogs
  ) {
    if (showAllLogs) {
      q = query(collection(db, "salesLog"), orderBy("soldAt", "desc"), limit(50));
      document.getElementById("log-title-suffix").textContent = "كل العمليات (آخر 50)";
    } else {
      q = query(collection(db, "salesLog"), orderBy("soldAt", "desc"), limit(5));
      document.getElementById("log-title-suffix").textContent = "آخر 5 فقط";
    }
  } else {
    q = query(collection(db, "salesLog"), where("user", "==", userData.uid), orderBy("soldAt", "desc"), limit(5));
    document.getElementById("log-title-suffix").textContent = "سجلات عملياتك (آخر 5)";
  }
  const snapshot = await getDocs(q);
  snapshot.forEach(docx => {
    const d = docx.data();
    let uname = d.userName || (usersMap[d.user]?.name ?? "");
    let uemail = d.userEmail || (usersMap[d.user]?.email ?? "");
    let userDisplay = uname ? uname : (uemail ? uemail.split("@")[0] : "-");
    table.innerHTML += `<tr><td>${d.code}</td><td>${d.category}</td><td>${d.date}</td><td>${d.time}</td><td>${userDisplay}</td></tr>`;
  });
}
document.getElementById("toggle-log-btn").onclick = async () => {
  showAllLogs = !showAllLogs;
  await updateLog();
  document.getElementById("toggle-log-btn").textContent = showAllLogs ? "عرض أقل" : "عرض المزيد";
};
document.getElementById("search-box").onkeyup = async function() {
  const val = this.value.trim();
  const table = document.getElementById("sales-log");
  table.innerHTML = "";
  let q = query(collection(db, "salesLog"), orderBy("soldAt", "desc"), limit(50));
  const snapshot = await getDocs(q);
  snapshot.forEach(docx => {
    const d = docx.data();
    if (d.code.includes(val))
      table.innerHTML += `<tr><td>${d.code}</td><td>${d.category}</td><td>${d.date}</td><td>${d.time}</td><td>${d.userName || d.userEmail || "-"}</td></tr>`;
  });
};

// ====== صلاحيات المالك ======
document.getElementById("delete-all-cards").onclick = async () => {
  if (!confirm("هل أنت متأكد من حذف كل الكروت؟")) return;
  showLoader("جاري حذف الكروت...");
  const q = query(collection(db, "cards"));
  const snapshot = await getDocs(q);
  for (let docx of snapshot.docs) {
    await deleteDoc(doc(db, "cards", docx.id));
  }
  await updateStats();
  showToast("تم حذف كل الكروت.", "success");
  hideLoader();
};
document.getElementById("see-all-logs").onclick = async () => {
  showAllLogs = true;
  await updateLog();
  document.getElementById("toggle-log-btn").textContent = "عرض أقل";
};

// ====== تحويل الرصيد ======
document.getElementById('transfer-btn').onclick = async () => {
  if (userData.role !== "owner" && !userData.permissions?.transfer) {
    showToast("ليست لديك صلاحية تحويل الرصيد.", "error");
    return;
  }
  const accNum = document.getElementById('transfer-acc').value.trim();
  const amount = parseInt(document.getElementById('transfer-amount').value.trim());
  document.getElementById('transfer-result').textContent = "";
  if (!accNum || isNaN(amount) || amount <= 0) {
    document.getElementById('transfer-result').textContent = "يرجى إدخال رقم حساب صحيح ومبلغ أكبر من صفر";
    showToast("يرجى إدخال بيانات صحيحة.", "error");
    return;
  }
  showLoader("جاري تحويل الرصيد...");
  const q = query(collection(db, "users"), where("accountNumber", "==", parseInt(accNum)));
  const snap = await getDocs(q);
  if (snap.empty) {
    document.getElementById('transfer-result').textContent = "لم يتم العثور على مستخدم بهذا الرقم";
    showToast("لم يتم العثور على المستخدم.", "error");
    hideLoader();
    return;
  }
  const userDoc = snap.docs[0];
  const userRef = doc(db, "users", userDoc.id);
  const balanceNow = userDoc.data().balance || 0;
  await updateDoc(userRef, { balance: balanceNow + amount });
  await addDoc(collection(db, "transfers"), {
    from: userData.uid,
    to: userDoc.data().uid,
    toAccount: userDoc.data().accountNumber,
    toEmail: userDoc.data().email,
    toName: userDoc.data().name || "",
    amount,
    date: (new Date()).toLocaleDateString(),
    time: (new Date()).toLocaleTimeString(),
    at: serverTimestamp()
  });
  document.getElementById('transfer-result').textContent = "تم تحويل الرصيد بنجاح";
  showToast("تم تحويل الرصيد بنجاح", "success");
  await loadUsers();
  hideLoader();
};

// ====== تقارير تحويل الرصيد ======
document.getElementById("show-transfer-report").onclick = async () => {
  await renderTransferReport();
  document.getElementById("transfer-report-modal").style.display = "flex";
};
document.getElementById("close-transfer-report").onclick = () => {
  document.getElementById("transfer-report-modal").style.display = "none";
};
async function renderTransferReport() {
  const usersSnap = await getDocs(collection(db, "users"));
  const transfersSnap = await getDocs(collection(db, "transfers"));
  let report = {};
  transfersSnap.forEach(doc => {
    const tr = doc.data();
    if (!report[tr.toAccount]) report[tr.toAccount] = { count: 0, total: 0, details: [] };
    report[tr.toAccount].count += 1;
    report[tr.toAccount].total += tr.amount;
    report[tr.toAccount].details.push(tr);
  });
  let html = `<table style="font-size:15px;"><tr><th>رقم الحساب</th><th>الإسم</th><th>البريد</th><th>عدد العمليات</th><th>إجمالي الرصيد المحول</th><th>تفاصيل</th></tr>`;
  usersSnap.forEach(doc => {
    const u = doc.data();
    const acc = u.accountNumber;
    html += `<tr>
      <td>${acc}</td>
      <td>${u.name ?? "-"}</td>
      <td>${u.email}</td>
      <td>${report[acc]?.count || 0}</td>
      <td>${report[acc]?.total || 0}</td>
      <td>${report[acc]?.details ? `<button onclick="window.showTransferDetails(${acc})">عرض</button>` : "-"}</td>
    </tr>`;
  });
  html += "</table><div id='transfer-details-view'></div>";
  document.getElementById("transfer-report-table").innerHTML = html;
  window.showTransferDetails = function(acc) {
    if (!report[acc] || !report[acc].details) return;
    let dhtml = `<table style="font-size:14px;margin-top:8px;"><tr><th>التاريخ</th><th>الوقت</th><th>المبلغ</th></tr>`;
    for (let t of report[acc].details) {
      dhtml += `<tr><td>${t.date}</td><td>${t.time}</td><td>${t.amount}</td></tr>`;
    }
    dhtml += "</table>";
    document.getElementById('transfer-details-view').innerHTML = dhtml;
  };
}

// ====== نافذة الكروت المباعة ======
function showModal(cat, codes) {
  document.getElementById("modal-title").textContent = `تم بيع ${codes.length} كروت من فئة ${cat}`;
  soldContent = codes.join("\n");
  soldCategory = cat;
  document.getElementById("modal-cards-list").textContent = soldContent;
  document.getElementById("result-modal").style.display = "flex";
}
document.getElementById("close-modal").onclick = () => {
  document.getElementById("result-modal").style.display = "none";
};
document.getElementById("copy-sold").onclick = () => {
  navigator.clipboard.writeText(soldContent).then(() => showToast("تم نسخ الكروت.", "success"));
};
document.getElementById("whatsapp-sold").onclick = () => {
  let msg = `كروت ${soldCategory}:\n` + soldContent;
  let url = "https://wa.me/?text=" + encodeURIComponent(msg);
  window.open(url, '_blank');
};

// ====== إغلاق جميع النوافذ المنبثقة بالضغط خارجها ======
window.addEventListener('mousedown', function(e){
  document.querySelectorAll('.modal').forEach(modal => {
    if (modal.style.display === "flex" && !modal.querySelector('.modal-content').contains(e.target)) {
      modal.style.display = "none";
    }
  });
});

// ====== لوحة تحكم المالك ======
document.getElementById("admin-btn").onclick = () => {
  window.scrollTo(0,0);
  document.querySelector("#owner-section").scrollIntoView({behavior:"smooth"});
};

// ===== حماية إضافية: أي لودر يبقى أكثر من 10 ثواني يتم إخفاؤه تلقائيًا =====
setInterval(()=>hideLoader(), 10000);




  </script>
 
</body>
</html>
